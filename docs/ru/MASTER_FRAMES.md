# Создание калибровочных мастер-кадров

Это руководство описывает создание мастер-биасов, дарков, флэтов и списков косметической коррекции с помощью инструментов PULSAR.

---

## Быстрый старт

### Мастер-биас

```bash
med bias*.fit master_bias.fit
```

### Мастер-дарки + Cosme-списки

```bash
# Автосоздание дарков, сгруппированных по выдержке + генерация cosme-списков
makedark darks_folder/

# С вычитанием биаса
makedark darks_folder/ master_bias.fit
```

### Мастер-флэты

```bash
# Автосоздание флэтов, сгруппированных по фильтру (требуются дарки в текущей папке)
makeflat flats_folder/

# С указанием целевой медианы
makeflat flats_folder/ 10000
```

### Список горячих пикселей (вручную)

```bash
# Создать cosme-список из существующего мастер-дарка
make_cosme master_dark.fit cosme.lst
```

---

## Типы калибровочных кадров

| Кадр | Что это | Как снимать | Инструмент |
|------|---------|-------------|------------|
| **Bias** | Паттерн шума считывания | Минимальная выдержка, закрыто | `med` |
| **Dark** | Тепловой шум (тёмновой ток) | Та же выдержка что у лайтов, закрыто | `makedark` |
| **Flat** | Отклик оптики (виньетирование, пыль) | Равномерный свет, 25-40% гистограммы | `makeflat` |
| **Cosme** | Список координат горячих пикселей | — | `makedark` (авто) или `make_cosme` |

### Рекомендации по съёмке

**Биас-кадры:**
- Установить минимально возможную выдержку (минимум камеры)
- Полностью закрыть телескоп/объектив
- Снять 20-50 кадров

**Дарк-кадры:**
- Та же выдержка, что и у лайтов
- Та же температура, что при съёмке
- Полностью закрыть телескоп
- Снять 20-50 кадров для каждой выдержки

**Флэт-кадры:**
- Равномерное освещение (сумеречное небо, световая панель или футболка на телескопе)
- Экспозиция до уровня 25-40% гистограммы
  - Ближе к уровню фона неба — меньше влияние нелинейности
  - Слишком низкий уровень = чрезмерный вклад шума флэтов
- Снять 20-50 кадров для каждого фильтра
- Та же оптическая конфигурация, что и у лайтов

---

## Справочник по инструментам

### med.py — Медианное объединение

Универсальный инструмент для объединения любых FITS-изображений попиксельной медианой.

```
med.py input_spec output.fit [--memory N]
```

| Опция | Описание |
|-------|----------|
| `--memory N` | Макс. память в ГБ для стека (по умолчанию: 16) |

**Форматы ввода:**

```bash
med bias*.fit master_bias.fit      # Маска с подстановкой
med bias0001.fit master_bias.fit   # Нумерованная последовательность (автообнаружение)
med @biaslist.txt master_bias.fit  # Файл-список
```

**Когда использовать:**
- Создание мастер-биаса (всегда)
- Создание мастер-дарков когда вычитание биаса не нужно
- Любая задача медианного стекинга

---

### makedark.py — Создатель мастер-дарков

Автоматизированная обработка дарк-кадров с вычитанием биаса и детекцией горячих пикселей.

```
makedark.py input_spec [bias_spec]
```

| Аргумент | Описание |
|----------|----------|
| `input_spec` | Каталог, маска файлов или список дарк-кадров |
| `bias_spec` | Опционально: файл биаса, список файлов или числовая константа (по умолчанию: 0) |

**Выходные файлы (в текущем каталоге):**

| Файл | Описание |
|------|----------|
| `dark<exp>.fit` | Мастер-дарк для каждой выдержки |
| `cosme<exp>.lst` | Список горячих пикселей для каждой выдержки |
| `bias.fit` | Мастер-биас (если bias_spec был списком файлов) |

**Как это работает:**

1. Сканирует входные файлы с `IMAGETYP='Dark Frame'`
2. Группирует по времени экспозиции (из заголовка `EXPTIME`)
3. Вычитает биас из каждого кадра (если указан)
4. Медианно объединяет каждую группу
5. Детектирует горячие пиксели и записывает cosme-списки (10 000 самых горячих)

**Примеры:**

```bash
makedark darks/                    # Базовый (без вычитания биаса)
makedark darks/ master_bias.fit   # С файлом мастер-биаса
makedark darks/ bias*.fit          # С биас-кадрами (создаст bias.fit)
makedark darks/ 100                # С числовой константой биаса
```

**Формат выдержки:** `dark120s.fit` (секунды), `dark500ms.fit` (миллисекунды)

---

### makeflat.py — Создатель мастер-флэтов

Автоматизированная обработка флэт-кадров с вычитанием дарков и нормализацией.

```
makeflat.py input_spec [target_median]
```

| Аргумент | Описание |
|----------|----------|
| `input_spec` | Каталог, маска файлов или список флэт-кадров |
| `target_median` | Целевая медиана для нормализации (по умолчанию: 5000) |

**Выходные файлы:** `flat_<filter>.fit` для каждого фильтра

**Как это работает:**

1. Сканирует входные файлы с `IMAGETYP='Flat Frame'`
2. Группирует по фильтру (из заголовка `FILTER`)
3. Проверяет консистентность выдержки внутри каждой группы
4. Находит соответствующие `dark<exp>.fit` и `cosme<exp>.lst`
5. Вычитает дарки, применяет косметическую коррекцию
6. Нормализует каждый кадр к целевой медиане
7. Медианно объединяет каждую группу

**Предварительные требования:** Для каждой выдержки флэтов нужны `dark<exp>.fit` и `cosme<exp>.lst` в текущем или входном каталоге.

**Именование фильтров:** `flat_l.fit` (Люминанс), `flat_r.fit`/`flat_g.fit`/`flat_b.fit` (RGB), `flat_h.fit` (H-alpha), `flat_o.fit` (OIII), `flat_s.fit` (SII)

---

### make_cosme.py — Создание списка горячих пикселей

Создаёт списки косметической коррекции, находя самые горячие пиксели на изображении.

**Псевдонимы:** `make_cosme`, `find_hot`

```
make_cosme.py input.fit output.lst
```

Находит 10 000 самых горячих (ярких) пикселей и записывает координаты в файл `.lst`.

**Формат вывода (совместим с IRIS):**

Формат `.lst` совместим с программой **IRIS** (© Christian Buil):

```
P 1234 567
P 2345 678
```

- Каждая строка: `P X Y` (P = маркер пикселя, X Y = координаты с нулевой индексацией)
- Строки, начинающиеся с `#`, являются комментариями
- Окончания строк CRLF для совместимости с Windows

**Когда использовать:**
- `makedark` создаёт cosme-списки автоматически
- Используйте `make_cosme` вручную для существующих мастер-дарков без cosme-файлов

---

## Требуемые FITS-заголовки

| Тип кадра | Заголовок | Обязательно | Описание |
|-----------|-----------|-------------|----------|
| Dark | `IMAGETYP` | Да | Должен быть "Dark Frame" |
| Dark | `EXPTIME` | Да | Время экспозиции в секундах |
| Flat | `IMAGETYP` | Да | Должен быть "Flat Frame" |
| Flat | `EXPTIME` | Да | Время экспозиции в секундах |
| Flat | `FILTER` | Да | Название фильтра |
| Bias | — | — | `med.py` работает с любыми FITS-файлами |

---

## Полный пример рабочего процесса

```bash
cd /calibration/2024_05_20/

# Шаг 1: Создание мастер-биаса
med bias*.fit bias.fit

# Шаг 2: Создание мастер-дарков (также создаёт cosme-списки)
makedark darks/ bias.fit
# Результат: dark120s.fit, dark300s.fit, cosme120s.lst, cosme300s.lst

# Шаг 3: Создание мастер-флэтов
makeflat flats/
# Результат: flat_l.fit, flat_r.fit, flat_ha.fit и т.д.

# Шаг 4: Проверка результатов
ls -la *.fit *.lst
fitshdr dark120s.fit
fitshdr flat_l.fit
```

---

## Советы и лучшие практики

### Соответствие температуры

Тёмновой ток зависит от температуры сенсора:
- Снимайте дарки при той же температуре, что и лайты
- Или используйте охлаждение камеры для поддержания постоянной температуры
- Проверяйте заголовок `CCD-TEMP` если доступен

### Достаточное количество кадров

Больше кадров = чище мастер:
- **Минимум**: 15-20 кадров
- **Рекомендуется**: 30-50 кадров
- **Убывающая отдача** после ~50 кадров

### Уровень экспозиции флэтов

- Целевой уровень 25-40% от полной ёмкости
- Ближе к уровню фона неба — минимизация эффектов нелинейности
- Слишком низко — возрастает вклад шума флэтов
- Консистентная экспозиция внутри группы фильтра

### Организация хранения

Рекомендуемая структура:
```
CalibrationLibrary/
├── 2024_05_20/
│   ├── bias.fit
│   ├── dark120s.fit
│   ├── dark300s.fit
│   ├── cosme120s.lst
│   ├── cosme300s.lst
│   ├── flat_l.fit
│   └── flat_ha.fit
└── 2024_06_15/
    └── ...
```

---

## Устранение проблем

| Проблема | Причина | Решение |
|----------|---------|---------|
| "No dark frames found" | Отсутствует заголовок IMAGETYP | Добавьте `IMAGETYP='Dark Frame'` в заголовки |
| "No flat frames found" | Отсутствует заголовок IMAGETYP | Добавьте `IMAGETYP='Flat Frame'` в заголовки |
| "Inconsistent exposures" | Смешанные выдержки в группе флэтов | Разделите флэты по выдержкам |
| "Dark not found for exposure" | Отсутствует мастер-дарк | Сначала запустите `makedark` |
| Остались горячие пиксели | Не найден cosme-список | Проверьте наличие и именование cosme-файла |
| Градиент на флэте | Неравномерное освещение | Переснимите флэты с лучшим источником света |

