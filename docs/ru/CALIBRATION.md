# Руководство по скриптам калибровки

Это руководство описывает `calibrate.py` (ручная калибровка) и `autocalibrate.py` (автоматическая калибровка с подбором дарков/флэтов).

---

## Быстрый старт

### calibrate.py — Ручная калибровка

Простая калибровка с явным указанием мастер-кадров:

```bash
# Базовый вариант: только вычитание дарка
calibrate raw001.fit out.fit -d master_dark.fit

# Полный: дарк + биас + флэт с множителем
calibrate raw001.fit out.fit -d dark.fit -b bias.fit -f flat.fit 25000

# С оптимизацией и косметической коррекцией
calibrate raw*.fit calibrated.fit -d dark.fit -f flat.fit 25000 -c cosme.lst -o
```

### autocalibrate.py — Автоматическая калибровка

Автоподбор дарков и флэтов из дерева каталогов:

```bash
# Базовое использование
autocalibrate lights/*.fit output darks/ flats/

# С выбором лучшего флэта для каждой сессии
autocalibrate --bestflat lights/*.fit output darks/ flats/

# С логом обслуживания для интервалов флэтов
autocalibrate --flatlog maintenance.csv lights/*.fit output darks/ flats/

# Режим отладки (сохраняет превью-изображения)
autocalibrate --bestflat --debug lights/*.fit output darks/ flats/
```

---

## Формула калибровки

Оба скрипта используют одну формулу:

```
РЕЗУЛЬТАТ = (RAW - BIAS - DARK × K) × MULT / FLAT
```

Где:
- **RAW** — исходный лайт-кадр
- **BIAS** — мастер-биас (опционально, только `calibrate.py`)
- **DARK** — мастер-дарк
- **K** — множитель дарка (1.0 или оптимизированный для кадра)
- **FLAT** — мастер-флэт
- **MULT** — множитель флэта = медиана(FLAT)

---

## calibrate.py — Подробное описание

### Синтаксис

```
calibrate.py rawfiles.fit outfiles.fit -d dark.fit [-b bias.fit] [-f flat.fit K] [-c cosme.lst] [-o]
```

### Опции

| Опция | Описание |
|-------|----------|
| `-d dark.fit` | Мастер-дарк (обязательно) |
| `-b bias.fit` | Мастер-биас (опционально) |
| `-f flat.fit K` | Мастер-флэт и множитель K (например, `-f flat.fit 25000`) |
| `-c cosme.lst` | Список пикселей для косметической коррекции |
| `-o` или `-optimize` | Вычислять оптимальный множитель дарка для каждого кадра |

### Оптимизация дарка

С флагом `-o` скрипт вычисляет оптимальный коэффициент масштабирования K для каждого кадра:

1. Делит изображение на тайлы 256×256
2. Исключает тайлы с насыщенными или нулевыми пикселями
3. Для каждого валидного тайла вычисляет K, минимизирующий остаток: `sum((R - B - K×D)²)`
4. Возвращает медиану K по всем валидным тайлам

Это компенсирует температурные вариации тёмнового тока.

### Примеры

```bash
# Обработка нумерованной последовательности
calibrate light0001.fit calib.fit -d dark.fit -f flat_L.fit 24500

# Обработка по маске с оптимизацией
calibrate *.fit output/ -d dark.fit -f flat.fit 25000 -o

# Полный конвейер калибровки
calibrate @filelist.txt result.fit -d dark.fit -b bias.fit -f flat.fit 25000 -c cosme.lst -o
```

---

## autocalibrate.py — Подробное описание

### Синтаксис

```
autocalibrate.py [опции] rawfiles.fit output_path dark_path flat_path
```

### Опции

| Опция | Описание |
|-------|----------|
| `--bestflat` | Автовыбор лучшего флэта для каждой сессии наблюдений |
| `--debug` | Сохранять отладочные изображения в папку `./debug/` |
| `--flat-future-days N` | Макс. дней в будущем для принятия флэта (по умолчанию: 2) |
| `--flatlog FILE` | CSV-файл с датами обновления флэтов |

### Именование выходных файлов

Выходные файлы именуются автоматически:
```
<база>_exp<EXPTIME>_<FILTER>_<N>.fit
```

Пример: `output_exp120_L_001.fit`, `output_exp120_L_002.fit`, ...

---

## Структура каталогов

### Что ОБЯЗАТЕЛЬНО, а что РЕКОМЕНДУЕТСЯ

**ОБЯЗАТЕЛЬНО** (без этого не работает):
- Все метаданные читаются **только из FITS-заголовков** (EXPTIME, JD, FILTER)
- Имена файлов и структура папок **НЕ парсятся** — можно положить всё в одну папку

**РЕКОМЕНДУЕТСЯ** (для удобства):
- Организовать по датам/камерам/телескопам для упрощения управления
- Использовать осмысленные имена файлов для читаемости
- Хранить косметические файлы рядом с соответствующими дарками

### Каталог дарков

Каталоги сканируются **рекурсивно** — любая структура работает:

```
darks/                    # Все эти структуры работают одинаково:
├── dark120s.fit          # Всё в корне
├── dark300s.fit
├── cosme.lst             # Один cosme-файл для всех
│
├── 2024_05/              # Или по датам
│   ├── dark120s.fit
│   └── cosme120s.lst
│
└── camera_A/             # Или по камерам
    └── dark60s.fit
```

**Поиск косметических файлов** (в порядке приоритета):
1. Та же папка, имя выводится из имени дарка:
   - Если имя начинается с "dark": префикс "dark" заменяется на "cosme"
     - `dark120s.fit` → `cosme120s.lst`
     - `Dark_2024.fit` → `cosme_2024.lst`
   - Иначе: все вхождения "dark" заменяются на "cosme"
     - `master_dark_60s.fit` → `master_cosme_60s.lst`
2. Если не найден: самый свежий `.lst` файл где угодно в дереве дарков (fallback)

### Каталог флэтов

Как и дарки — сканируется **рекурсивно**, структура не важна:

```
flats/                    # Всё это работает:
├── flat_L.fit            # Всё в корне
├── flat_Ha.fit
│
├── 2024_05/              # Или по датам
│   ├── flat_L.fit
│   └── flat_Ha.fit
│
└── Telescope_A/          # Или по установке
    └── 2024_06/
        └── flat_L.fit
```

Флэты подбираются по **заголовку FILTER** и **заголовку JD** — не по именам файлов или путям.

---

## Требуемые FITS-заголовки

### Лайт-кадры (RAW)

| Заголовок | Обязательно | Описание |
|-----------|-------------|----------|
| `EXPTIME` или `EXPOSURE` | Да | Время экспозиции в секундах |
| `JD` | Да | Юлианская дата наблюдения |
| `FILTER` или `FILTERS` | Да | Название фильтра (L, R, G, B, Ha и т.д.) |
| `INSTRUME` | Для flatlog | Идентификатор камеры |

### Дарк-кадры

| Заголовок | Обязательно | Описание |
|-----------|-------------|----------|
| `EXPTIME` или `EXPOSURE` | Да | Время экспозиции в секундах |
| `JD` | Да | Юлианская дата съёмки дарка |

### Флэт-кадры

| Заголовок | Обязательно | Описание |
|-----------|-------------|----------|
| `FILTER` или `FILTERS` | Да | Название фильтра |
| `JD` | Да | Юлианская дата съёмки флэта |

---

## Алгоритм подбора дарков

Дарки подбираются по времени экспозиции:

1. **Точное совпадение**: Ищем дарки с таким же EXPTIME (±1e-6 допуск)
   - Если несколько — выбираем самый свежий (максимальный JD)
2. **Ближайший**: Если точного совпадения нет — ищем ближайший EXPTIME
   - При равенстве — самый свежий JD

```
Пример: RAW имеет EXPTIME=120s

Доступные дарки:
  dark_120s.fit (JD=2460400)  ← Выбран (точное совпадение, самый свежий)
  dark_120s.fit (JD=2460350)
  dark_60s.fit  (JD=2460450)
```

---

## Алгоритмы подбора флэтов

### Стандартный режим (по умолчанию)

Флэты подбираются по фильтру и дате:

1. Находим флэты с совпадающим FILTER
2. Фильтруем по дате: `flat_JD ≤ raw_JD + flat_future_days`
3. Выбираем самый свежий (максимальный JD)
4. Если нет совпадения — пробуем фильтр L как запасной

```
Пример: RAW снят 2024-05-20, filter=Ha, --flat-future-days=2

Валидные флэты: JD ≤ 2024-05-22
  flat_Ha_2024-05-18.fit  ← Выбран (самый свежий валидный)
  flat_Ha_2024-05-10.fit
  flat_Ha_2024-05-25.fit  ✗ (слишком далеко в будущем)
```

### С логом обслуживания (--flatlog)

Когда оптический тракт модифицируется (камера повёрнута, фильтры заменены и т.д.), флэты становятся невалидными. Лог обслуживания определяет интервалы:

```csv
# maintenance.csv
# DATETIME_UTC,CAMERA_ID[,COMMENT]
2024-03-15T14:00:00,ASI2600MM,Начальная установка
2024-05-18T12:30:00,ASI2600MM,Поворот камеры
2024-07-01T10:00:00,ASI2600MM,Замена колеса фильтров
```

**Логика подбора**:
1. Находим интервал обслуживания, содержащий наблюдение
2. Сначала ищем флэты внутри этого интервала
3. Применяем ограничение `--flat-future-days` внутри интервала
4. Если в интервале есть флэты, но нет в пределах лимита — берём последний из интервала
5. Если интервал пуст — откатываемся к глобальному поиску

```
Пример: RAW снят 2024-06-15, camera=ASI2600MM

Интервалы обслуживания:
  2024-03-15 — 2024-05-18  (интервал A)
  2024-05-18 — 2024-07-01  (интервал B) ← RAW здесь
  2024-07-01 — ...         (интервал C)

Рассматриваются только флэты с 2024-05-18 по 2024-07-01.
```

### Выбор лучшего флэта (--bestflat)

Автоматически выбирает наилучший флэт по анализу качества изображения:

**Алгоритм**:

1. **Подготовка превью лайтов** (для каждой сессии наблюдений):
   - Уменьшение 8×8
   - Медианный фильтр (size=16) для удаления звёзд
   - Объединение попиксельной медианой по сессии

2. **Подготовка превью флэтов**:
   - Уменьшение 8×8
   - Нормализация к медиане 5000

3. **Оценка каждого кандидата-флэта**:
   - Деление: `light_preview / flat_preview`
   - High-pass фильтр (убирает градиенты)
   - Гауссово размытие (подавляет шум)
   - Вычисление sigma (стандартное отклонение)

4. **Выбор лучшего**: Выбирается для всей сессии тот флэт, который на пробном применении выдал наиболее плоское, имеющее менее всего среднечастотных локальных отклонений поле

**Сессии**: Наблюдения группируются по местному времени от полудня до полудня:
- 12:01 сегодня → 12:00 завтра = сегодняшняя сессия
- Это группирует все наблюдения одной ночи вместе

**Отладочный вывод** (`--debug`):
```
debug/
└── 2024_05_20_L/
    ├── light_median.fit           # Объединённое превью лайтов
    ├── hp_flat_L_20240518_sigma12.3_best.fit  # Лучший флэт
    └── hp_flat_L_20240510_sigma15.7.fit       # Другие кандидаты
```

---

## Косметическая коррекция

Коррекция горячих пикселей по списку координат.

### Формат

```
# cosme.lst
# Координаты X Y (индексация с 0)
1234 567
2345 678
3456 789
```

### Автообнаружение

Для дарков косметические файлы находятся автоматически:
- `dark120s.fit` → `cosme120s.lst`
- Если не найден — используется самый свежий `.lst` в дереве дарков

### Метод коррекции

Горячие пиксели заменяются медианой окружающих пикселей.

---

## Порядок обработки

Оба скрипта применяют коррекции в таком порядке:

1. **Вычитание биаса** (если указан)
2. **Вычитание дарка** (с опциональным масштабированием)
3. **Косметическая коррекция**
4. **Деление на флэт** (с множителем)
5. **Очистка NaN/Inf**
6. **Приведение к диапазону исходного типа данных**

---

## Советы и лучшие практики

### Рекомендуемая организация библиотеки

Эта структура **опциональна, но рекомендуется** для удобства управления:

```
CalibrationLibrary/
├── ASI2600MM/
│   ├── darks/
│   │   ├── 2024_05/
│   │   │   ├── dark120s.fit
│   │   │   └── cosme120s.lst
│   │   └── 2024_06/
│   │       └── dark120s.fit
│   └── flats/
│       ├── Telescope_A/
│       │   ├── 2024_05/
│       │   │   └── flat_L.fit
│       │   └── 2024_06/
│       │       └── flat_L.fit
│       └── Telescope_B/
│           └── flat_L.fit
└── maintenance.csv
```

Помните: **структура папок — только для вашего удобства** — скрипты читают все метаданные из FITS-заголовков.

### Множитель флэта

Множитель (MULT) компенсирует деление на флэт:
- Должен равняться медиане(FLAT) для сохранения яркости изображения
- `autocalibrate.py` вычисляет это автоматически
- Для `calibrate.py` проверьте медиану флэта: `fitshdr flat.fit | grep -i median`

### Проверка результатов

1. Сравните гистограммы до/после калибровки
2. Проверьте наличие «бубликов» от пыли (несовпадение флэта)
3. Убедитесь, что горячие пиксели исправлены
4. Проверьте остаточные градиенты (несовпадение дарка)

---

## Устранение проблем

| Проблема | Причина | Решение |
|----------|---------|---------|
| "No usable darks found" | Отсутствуют заголовки EXPTIME/JD | Добавьте заголовки к даркам |
| "No usable flats found" | Отсутствуют заголовки FILTER/JD | Добавьте заголовки к флэтам |
| Видны «бублики» от пыли | Выбран неправильный флэт | Используйте `--bestflat` или проверьте даты |
| Градиент на результате | Несовпадение дарка | Используйте `-o` оптимизацию или другой дарк |
| Остались горячие пиксели | Не найден cosme-файл | Создайте cosme.lst для дарка |
| "Shape mismatch" | Разные размеры изображений | Убедитесь, что все кадры одного размера |
