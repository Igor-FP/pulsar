{
  "permissions": {
    "allow": [
      "Bash(find:*)",
      "Bash(ls:*)",
      "Bash(git -C /mnt/s/src/AstroScripts/AstroBatch log --oneline -n 10)",
      "Bash(wc:*)",
      "Bash(cmd.exe /c 'reg query \"\"HKCU\\\\Environment\"\" /v Path')",
      "Bash(cmd.exe /c \"echo %PATH%\")",
      "Bash(tr:*)",
      "Bash(cmd.exe /c 'reg query \"\"HKCU\\\\Environment\"\"')",
      "Bash(powershell.exe -Command \"Get-ItemProperty -Path ''HKCU:\\\\Environment'' -Name Path -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Path\")",
      "Bash(\"/mnt/c/Users/Igor/AppData/Local/Programs/Python/Python311/python.exe\" -c \"\nfrom astropy.io import fits\nimport numpy as np\n\nwith fits.open\\(''Experiment/flat_h_my.fit'', memmap=False\\) as h1:\n    my = h1[0].data.astype\\(np.float64\\)\nwith fits.open\\(''Experiment/flat_h_iris.fit'', memmap=False\\) as h2:\n    iris = h2[0].data.astype\\(np.float64\\)\n\n# Нормализуем оба к медиане = 1.0 для сравнения структуры\nmy_norm = my / np.median\\(my\\)\niris_norm = iris / np.median\\(iris\\)\n\ndiff = my_norm - iris_norm\nratio = my_norm / iris_norm\n\nprint\\(''=== Разница нормализованных \\(my - iris\\) ===''\\)\nprint\\(f''  Min: {np.min\\(diff\\):.6f}''\\)\nprint\\(f''  Max: {np.max\\(diff\\):.6f}''\\)\nprint\\(f''  Mean: {np.mean\\(diff\\):.6f}''\\)\nprint\\(f''  Std: {np.std\\(diff\\):.6f}''\\)\nprint\\(\\)\nprint\\(''=== Отношение нормализованных \\(my / iris\\) ===''\\)\nprint\\(f''  Min: {np.min\\(ratio\\):.6f}''\\)\nprint\\(f''  Max: {np.max\\(ratio\\):.6f}''\\)\nprint\\(f''  Mean: {np.mean\\(ratio\\):.6f}''\\)\nprint\\(f''  Median: {np.median\\(ratio\\):.6f}''\\)\nprint\\(\\)\n\n# Гистограмма разницы\nprint\\(''=== Распределение разницы ===''\\)\nfor pct in [1, 5, 25, 50, 75, 95, 99]:\n    print\\(f''  {pct}%: {np.percentile\\(diff, pct\\):.6f}''\\)\n\")",
      "Bash(\"/mnt/c/Users/Igor/AppData/Local/Programs/Python/Python311/python.exe\" -c \"\nfrom astropy.io import fits\nimport numpy as np\n\nwith fits.open\\(''Experiment/flat_h_my.fit'', memmap=False\\) as h1:\n    my = h1[0].data.astype\\(np.float64\\)\nwith fits.open\\(''Experiment/flat_h_iris.fit'', memmap=False\\) as h2:\n    iris = h2[0].data.astype\\(np.float64\\)\n\nmy_norm = my / np.median\\(my\\)\niris_norm = iris / np.median\\(iris\\)\ndiff = my_norm - iris_norm\n\n# Где минимальные значения?\nmin_idx = np.unravel_index\\(np.argmin\\(diff\\), diff.shape\\)\nprint\\(f''Минимум разницы в пикселе: y={min_idx[0]}, x={min_idx[1]}''\\)\nprint\\(f''  my_norm:   {my_norm[min_idx]:.4f}''\\)\nprint\\(f''  iris_norm: {iris_norm[min_idx]:.4f}''\\)\nprint\\(f''  my \\(raw\\):  {my[min_idx]:.0f}''\\)\nprint\\(f''  iris \\(raw\\):{iris[min_idx]:.0f}''\\)\nprint\\(\\)\n\n# Сколько пикселей с большой разницей?\nthreshold = 0.05  # 5%\nbad = np.abs\\(diff\\) > threshold\nprint\\(f''Пикселей с разницей > {threshold*100}%: {np.sum\\(bad\\)} \\({100*np.sum\\(bad\\)/diff.size:.2f}%\\)''\\)\n\n# Где они расположены? Центр масс\nif np.sum\\(bad\\) > 0:\n    y_coords, x_coords = np.where\\(bad\\)\n    print\\(f''  Y: min={y_coords.min\\(\\)}, max={y_coords.max\\(\\)}, mean={y_coords.mean\\(\\):.0f}''\\)\n    print\\(f''  X: min={x_coords.min\\(\\)}, max={x_coords.max\\(\\)}, mean={x_coords.mean\\(\\):.0f}''\\)\n    print\\(f''  Размер изображения: {diff.shape}''\\)\n    \n# Проверим углы\nh, w = diff.shape\ncorners = {\n    ''top-left'': diff[0:100, 0:100],\n    ''top-right'': diff[0:100, -100:],\n    ''bottom-left'': diff[-100:, 0:100],\n    ''bottom-right'': diff[-100:, -100:],\n    ''center'': diff[h//2-50:h//2+50, w//2-50:w//2+50]\n}\nprint\\(\\)\nprint\\(''Средняя разница по регионам:''\\)\nfor name, region in corners.items\\(\\):\n    print\\(f''  {name}: {np.mean\\(region\\):.4f}''\\)\n\")",
      "Bash(\"/mnt/c/Users/Igor/AppData/Local/Programs/Python/Python311/python.exe\" -c \"\nfrom astropy.io import fits\nimport numpy as np\n\nwith fits.open\\(''Experiment/flat_h_my.fit'', memmap=False\\) as h1:\n    my = h1[0].data.astype\\(np.float64\\)\n    print\\(''=== HEADERS flat_h_my.fit ===''\\)\n    for key in [''HISTORY'', ''COMMENT'', ''EXPTIME'', ''EXPOSURE'', ''IMAGETYP'']:\n        if key in h1[0].header:\n            vals = h1[0].header[key]\n            if isinstance\\(vals, str\\):\n                print\\(f''  {key}: {vals}''\\)\n            else:\n                for v in h1[0].header[key]:\n                    print\\(f''  {key}: {v}''\\)\n\nprint\\(\\)\nwith fits.open\\(''Experiment/flat_h_iris.fit'', memmap=False\\) as h2:\n    iris = h2[0].data.astype\\(np.float64\\)\n    print\\(''=== HEADERS flat_h_iris.fit ===''\\)\n    for key in [''HISTORY'', ''COMMENT'', ''EXPTIME'', ''EXPOSURE'', ''IMAGETYP'']:\n        if key in h2[0].header:\n            vals = h2[0].header[key]\n            if isinstance\\(vals, str\\):\n                print\\(f''  {key}: {vals}''\\)\n            else:\n                for v in h2[0].header[key]:\n                    print\\(f''  {key}: {v}''\\)\n\")",
      "Bash(\"/mnt/c/Users/Igor/AppData/Local/Programs/Python/Python311/python.exe\" -c \"\nfrom astropy.io import fits\n\nfor fname in [''Experiment/flat_h_my.fit'', ''Experiment/flat_h_iris.fit'']:\n    print\\(f''=== {fname} ===''\\)\n    with fits.open\\(fname, memmap=False\\) as hdul:\n        h = hdul[0].header\n        # Print all history entries\n        if ''HISTORY'' in h:\n            for entry in h[''HISTORY'']:\n                print\\(f''  HISTORY: {entry}''\\)\n        for key in [''EXPTIME'', ''EXPOSURE'', ''IMAGETYP'', ''FILTER'']:\n            if key in h:\n                print\\(f''  {key}: {h[key]}''\\)\n    print\\(\\)\n\")",
      "Bash(\"/mnt/c/Users/Igor/AppData/Local/Programs/Python/Python311/python.exe\" -c \"\nfrom astropy.io import fits\nimport numpy as np\n\nwith fits.open\\(''Experiment/flat_h_my.fit'', memmap=False\\) as h1:\n    my = h1[0].data.astype\\(np.float64\\)\nwith fits.open\\(''Experiment/flat_h_iris.fit'', memmap=False\\) as h2:\n    iris = h2[0].data.astype\\(np.float64\\)\n\nprint\\(''=== Квантили ===''\\)\nprint\\(f''             my        iris''\\)\nfor pct in [5, 25, 50, 75, 95]:\n    my_q = np.percentile\\(my, pct\\)\n    iris_q = np.percentile\\(iris, pct\\)\n    print\\(f''  {pct:2d}%:   {my_q:7.1f}    {iris_q:7.1f}''\\)\n\nprint\\(\\)\nmy_5 = np.percentile\\(my, 5\\)\nmy_95 = np.percentile\\(my, 95\\)\niris_5 = np.percentile\\(iris, 5\\)\niris_95 = np.percentile\\(iris, 95\\)\n\nprint\\(''=== Соотношение 95%/5% ===''\\)\nprint\\(f''  my:   {my_95/my_5:.4f}''\\)\nprint\\(f''  iris: {iris_95/iris_5:.4f}''\\)\nprint\\(\\)\nprint\\(f''  Разница: {\\(my_95/my_5\\) / \\(iris_95/iris_5\\):.4f}''\\)\nprint\\(\\)\n\n# Также полезно - динамический диапазон\nprint\\(''=== Динамический диапазон \\(95% - 5%\\) ===''\\)\nprint\\(f''  my:   {my_95 - my_5:.1f}''\\)\nprint\\(f''  iris: {iris_95 - iris_5:.1f}''\\)\n\")",
      "Bash(\"/mnt/c/Users/Igor/AppData/Local/Programs/Python/Python311/python.exe\" -c \"\nfrom astropy.io import fits\nimport numpy as np\n\nwith fits.open\\(''Experiment/flat_h_my.fit'', memmap=False\\) as h1:\n    my = h1[0].data.astype\\(np.float64\\)\nwith fits.open\\(''Experiment/flat_h_iris.fit'', memmap=False\\) as h2:\n    iris = h2[0].data.astype\\(np.float64\\)\n\n# Нормализуем к одинаковой медиане\nmy_med = np.median\\(my\\)\niris_med = np.median\\(iris\\)\niris_scaled = iris * \\(my_med / iris_med\\)\n\n# Разница = что было вычтено в my, но не в iris\ndiff = iris_scaled - my\n\nprint\\(''=== Разница \\(iris_scaled - my\\) ===''\\)\nprint\\(''Это то, что makeflat вычел дополнительно''\\)\nprint\\(f''  Min: {np.min\\(diff\\):.1f}''\\)\nprint\\(f''  Max: {np.max\\(diff\\):.1f}''\\)\nprint\\(f''  Mean: {np.mean\\(diff\\):.1f}''\\)\nprint\\(f''  Median: {np.median\\(diff\\):.1f}''\\)\nprint\\(f''  Std: {np.std\\(diff\\):.1f}''\\)\nprint\\(\\)\n\n# Это должна быть структура dark''а!\nprint\\(''=== Распределение по регионам ===''\\)\nh, w = diff.shape\nregions = {\n    ''top-left'': diff[0:500, 0:500],\n    ''top-right'': diff[0:500, -500:],\n    ''bottom-left'': diff[-500:, 0:500],\n    ''bottom-right'': diff[-500:, -500:],\n    ''center'': diff[h//2-250:h//2+250, w//2-250:w//2+250]\n}\nfor name, region in regions.items\\(\\):\n    print\\(f''  {name}: mean={np.mean\\(region\\):.1f}, std={np.std\\(region\\):.1f}''\\)\n\")",
      "Bash(\"/mnt/c/Users/Igor/AppData/Local/Programs/Python/Python311/python.exe\" -c \"\nfrom astropy.io import fits\nimport numpy as np\n\nfiles = [''Experiment/dark300ms_my.fit'', ''Experiment/dark300ms_iris.fit'']\nfor f in files:\n    with fits.open\\(f, memmap=False\\) as hdul:\n        data = hdul[0].data.astype\\(np.float64\\)\n        print\\(f''=== {f} ===''\\)\n        print\\(f''  Shape: {data.shape}''\\)\n        print\\(f''  Min: {np.min\\(data\\):.1f}''\\)\n        print\\(f''  Max: {np.max\\(data\\):.1f}''\\)\n        print\\(f''  Mean: {np.mean\\(data\\):.1f}''\\)\n        print\\(f''  Median: {np.median\\(data\\):.1f}''\\)\n        print\\(f''  5%: {np.percentile\\(data, 5\\):.1f}''\\)\n        print\\(f''  95%: {np.percentile\\(data, 95\\):.1f}''\\)\n        print\\(\\)\n\n# Сравнение\nwith fits.open\\(''Experiment/dark300ms_my.fit'', memmap=False\\) as h1:\n    my = h1[0].data.astype\\(np.float64\\)\nwith fits.open\\(''Experiment/dark300ms_iris.fit'', memmap=False\\) as h2:\n    iris = h2[0].data.astype\\(np.float64\\)\n\ndiff = my - iris\nprint\\(''=== Разница \\(my - iris\\) ===''\\)\nprint\\(f''  Min: {np.min\\(diff\\):.1f}''\\)\nprint\\(f''  Max: {np.max\\(diff\\):.1f}''\\)\nprint\\(f''  Mean: {np.mean\\(diff\\):.1f}''\\)\nprint\\(f''  Median: {np.median\\(diff\\):.1f}''\\)\nprint\\(\\)\n\n# По регионам\nh, w = diff.shape\nregions = {\n    ''top-left'': diff[0:500, 0:500],\n    ''top-right'': diff[0:500, -500:],\n    ''bottom-left'': diff[-500:, 0:500],\n    ''bottom-right'': diff[-500:, -500:],\n    ''center'': diff[h//2-250:h//2+250, w//2-250:w//2+250]\n}\nprint\\(''=== Разница по регионам ===''\\)\nfor name, region in regions.items\\(\\):\n    print\\(f''  {name}: {np.mean\\(region\\):.1f}''\\)\n\")",
      "Bash(\"/mnt/c/Users/Igor/AppData/Local/Programs/Python/Python311/python.exe\" -c \"\nfrom astropy.io import fits\nimport numpy as np\n\nwith fits.open\\(''Experiment/flat_h_my.fit'', memmap=False\\) as h1:\n    my = h1[0].data.astype\\(np.float64\\)\nwith fits.open\\(''Experiment/flat_h_iris.fit'', memmap=False\\) as h2:\n    iris = h2[0].data.astype\\(np.float64\\)\nwith fits.open\\(''Experiment/dark300ms_iris.fit'', memmap=False\\) as hd:\n    dark = hd[0].data.astype\\(np.float64\\)\n\n# Нормализуем оба flat''а к медиане = 1\nmy_norm = my / np.median\\(my\\)\niris_norm = iris / np.median\\(iris\\)\n\n# ''Восстановим'' приблизительный raw flat\n# raw_flat ≈ flat_norm * scale + dark\n# Используем типичное значение для sky flat\ntypical_raw_median = 32000  # примерно\n\nmy_raw_approx = my_norm * \\(typical_raw_median - np.median\\(dark\\)\\) + dark\niris_raw_approx = iris_norm * \\(typical_raw_median - np.median\\(dark\\)\\) + dark\n\nprint\\(''Приблизительно восстановленные raw flats:''\\)\nprint\\(f''my: median = {np.median\\(my_raw_approx\\):.0f}''\\)\nprint\\(f''iris: median = {np.median\\(iris_raw_approx\\):.0f}''\\)\nprint\\(\\)\n\n# Теперь применим формулу IRIS к обоим\nmy_darksub = my_raw_approx - dark\niris_darksub = iris_raw_approx - dark\n\nmy_iris_style = my_darksub / np.median\\(my_darksub\\)\niris_iris_style = iris_darksub / np.median\\(iris_darksub\\)\n\nprint\\(''После IRIS-style обработки:''\\)\nprint\\(f''my -> iris_style:   median={np.median\\(my_iris_style\\):.4f}''\\)\nprint\\(f''iris -> iris_style: median={np.median\\(iris_iris_style\\):.4f}''\\)\n\n# Разница\ndiff = my_iris_style - iris_iris_style\nprint\\(f''Разница: mean={np.mean\\(diff\\):.6f}, std={np.std\\(diff\\):.6f}''\\)\n\")",
      "Bash(\"/mnt/c/Users/Igor/AppData/Local/Programs/Python/Python311/python.exe\" MakeFlat/makeflat.py \"Experiment/Source/FLAT_F_Ha_*.fit\" 5000)",
      "Bash(python -c:*)",
      "Bash(/mnt/c/Users/Igor/AppData/Local/Programs/Python/Python311/python.exe -c:*)",
      "Bash(python -m py_compile:*)",
      "Bash(python3:*)",
      "Bash(xargs:*)"
    ]
  }
}
